#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# This was a great aid to writing this script:
# https://github.com/heroku/heroku-buildpack-ci-postgresql/blob/master/bin/compile

# fail fast
#set -e

# debug
#set -x

echo "-----> In bin/compile"

# parse and derive params
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3
BUILDPACK_DIR="$(dirname $(dirname $0))"

function error() {
  echo " !     $*" >&2
  exit 1
}

function indent() {
  c='s/^/       /'
  case $(uname) in
    Darwin) sed -l "$c";;
    *)      sed -u "$c";;
  esac
}

# The heroku ruby buildpack will have already installed the gems for the default Gemfile, so now
# install the missing gems from que-1-gemfile/Gemfile.
echo "-----> Installing que-1-gemfile/Gemfile gems"
cd $BUILD_DIR
bundle_without="development:test"
set -o pipefail # Enable pipefail so failure exit code from bundle install will not be lost by pipe to indent.
BUNDLE_GEMFILE=que-1-gemfile/Gemfile bundle install --without $bundle_without --path vendor/bundle --binstubs vendor/bundle/bin -j4 --deployment | indent
bundle_install_status=$?
set +o pipefail # Disable pipefail, only needed for above command as it is pipes to indent.

if [ $bundle_install_status -ne 0 ]; then
  error "bundle install error: This can happen when que-1-gemfile/Gemfile.lock falls out of sync with que-1-gemfile/Gemfile. Check the committed que-1-gemfile/Gemfile.lock is up-to-date."
fi

echo "-----> Multiple Gemfiles done"
